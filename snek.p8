pico-8 cartridge // http://www.pico-8.com
version 33
__lua__
function _init()
	game_over = false

	score = 0
	cells = 128/8
	tick = 0
	apples = {}
	parts = {}
	partsize = 8
	snek_speed = partsize
	add_part(1,32,8)
	add_part(3,24,8)

	dir = {"n","e","s","w"}

	head = parts[1]

	srand()
	spawn_apple()
end

function _update()
	if(game_over) then
		if(btnp(5)) then
			_init()
		end
		return
	end

	tick += 1

	-- Handle head input regardless of tick
   	head.dx = 0
    head.dy = 0
    
	-- Turn
    if(btnp(0)) pleft()
    if(btnp(1)) pright()

    -- Accelerate
    if (pdir() == "e") then
        head.dx += snek_speed
    end
    if (pdir() == "w") then
        head.dx -= snek_speed
    end
    if (pdir() == "s") then
        head.dy += snek_speed
    end
    if (pdir() == "n") then
         head.dy -= snek_speed
    end

	if (tick >= 7) then
		move_head()
		for i=2,#parts do
			move_part(i)
		end
		tick = 0
	end

	check_food_collide()
	check_snek_collide()
	check_wall_collide()
end

function _draw()
	cls()
	map()
	foreach(apples, draw_apple)

	foreach(parts, draw_part)

	if(game_over) then
		print("press \151 to start", 30, 60, 7)
	end
	print("score: "..score,0,0,7)
end

-- Player Direction handling
function pdir()
    return dir[head.dir]
end
function pleft()
    if (head.dir -1 == 0) then
         head.dir = #dir
    else
        head.dir -= 1
    end
end
function pright()
    if (head.dir + 1 > #dir) then
        head.dir = 1
    else
        head.dir +=1
    end
end

function add_part(sp, x,y)
	local p = {
		sp=sp,
		x=x,
		y=y,
		dx=0,
		dy=0,
		dir=2
	}
	add(parts, p)
end

function draw_part(p)
	local flipx = pdir() == "w"
	local flipy = pdir() == "n"
	local sp = p.sp

	if(p == head) then
		if(pdir() == 'n' or pdir() == 's') sp += 1
	end

	spr(sp,p.x,p.y, 1, 1,flipx,flipy)
end

function move_head()
	local p = parts[1]
	p.lastx = p.x
	p.lasty = p.y

	p.x += p.dx
	p.y += p.dy
end

function move_part(i)
	local p = parts[i]
	p.lastx = p.x
	p.lasty= p.y

	p.x = parts[i-1].lastx
	p.y = parts[i-1].lasty
end

function spawn_apple()
	local cellx = flr(randb(1,cells - 1))
	local celly = flr(randb(1,cells - 1))

	local a = {
		sp = 4,
		x = cellx * 8,
		y = celly * 8,
	}
	add(apples, a)
end

function draw_apple(a)
	spr(a.sp,a.x,a.y)
end

function check_food_collide()
	for x,v in pairs(apples) do
		if(v.x == head.x and v.y == head.y) then
			eat(v)
		end
	end
end

function eat(apple)
	local tail = parts[#parts]
	add_part(3,tail.x,tail.y)
	del(apples, apple)
	score += 100
	sfx(2)
	spawn_apple()
end

function check_snek_collide()
	for x,v in pairs(parts) do
		if(head != v and v.x == head.x and v.y == head.y) then
			die()
		end
	end
end

function check_wall_collide()
	if(head.x < 8 or head.x > 112 or head.y < 8 or head.y > 112) then
		die()
	end
end

function die()
	sfx(1)
	game_over = true
end

--random int between l,h
function randb(l,h) --exclusive
    return flr(rnd(h-l))+l
end

__gfx__
00000000333333333333333300000000000330000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333337333333333303333330088888800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700333333333333333303333330888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000333333383333333303333330888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000333333383333333303333330888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00700700333333333733337303333330888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333337333333333303333330888888880000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000333333333338833300000000008888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
3030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3000000000000000000000000000003030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
3030303030303030303030303030303030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
000a00000d5500a550085500555003550005500055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
001000001705000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
00 01424344

